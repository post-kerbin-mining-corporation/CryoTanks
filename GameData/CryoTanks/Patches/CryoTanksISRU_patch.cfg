//=====================================================================================
// adds LH2, LH2Ox, LCH4, LCH4Ox Converters to parts, that are in CryoTanksISRU_Opt-In
//=====================================================================================


@PART:HAS[#CryoTanks_Converter[Set]]:FOR[CryoTanks]
{
	CryoTanks_EC_Hydrogen = 1 // 1.666667   // Modifier for input EC Consumption of LH2, LH2Ox
	CryoTanks_EC_Methane  = 1 // 1.333333   // Modifier for input EC Consumption of LCH4, LCH4Ox

	// remove any "unbalanced" LH2/LCH4 Converters
	-MODULE[ModuleResourceConverter]:HAS[@OUTPUT_RESOURCE:HAS[#ResourceName[LqdHydrogen]]],*{}
	-MODULE[ModuleResourceConverter]:HAS[@OUTPUT_RESOURCE:HAS[#ResourceName[LqdMethane]]],*{}

	// patch LF to LH2
	+MODULE[ModuleResourceConverter]:HAS[@OUTPUT_RESOURCE:HAS[#ResourceName[LiquidFuel]],!OUTPUT_RESOURCE:HAS[#ResourceName[Oxidizer]]]
	{
		@ConverterName = #LOC_CryoTanks_isru_LH2_name
		@StartActionName = #LOC_CryoTanks_isru_LH2_StartAction
		@StopActionName = #LOC_CryoTanks_isru_LH2_StopAction
	    @ToggleActionName = #LOC_CryoTanks_isru_LH2_ToggleAction
		Tag = CryoTanks_Hydrogen

		// Ore = 0.45

		@OUTPUT_RESOURCE:HAS[#ResourceName[LiquidFuel]]
		{
			@ResourceName = LqdHydrogen
			@Ratio *= 7.5 // 0.9 * 7.5 = 6.75   // legacy 141
		}
	}

	// patch LFOx to LH2Ox
	+MODULE[ModuleResourceConverter]:HAS[@OUTPUT_RESOURCE:HAS[#ResourceName[LiquidFuel]],@OUTPUT_RESOURCE:HAS[#ResourceName[Oxidizer]]]
	{
    	@ConverterName = #LOC_CryoTanks_isru_LH2Ox_name
		@StartActionName = #LOC_CryoTanks_isru_LH2Ox_StartAction
		@StopActionName = #LOC_CryoTanks_isru_LH2Ox_StopAction
    	@ToggleActionName = #LOC_CryoTanks_isru_LH2Ox_ToggleAction
		Tag = CryoTanks_Hydrogen
		
		// Ore = 0.5

		@OUTPUT_RESOURCE:HAS[#ResourceName[LiquidFuel]]
		{
			@ResourceName = LqdHydrogen
			@Ratio /= 0.45
			@Ratio *= 4.995    // legacy 24.7412
		}

		@OUTPUT_RESOURCE:HAS[#ResourceName[Oxidizer]]
		{
			@DumpExcess = true // false
			@Ratio /= 0.55
			@Ratio *= 0.333    // legacy 1.64942
		}
	}

	// patch LF to LCH4
	+MODULE[ModuleResourceConverter]:HAS[@OUTPUT_RESOURCE:HAS[#ResourceName[LiquidFuel]],!OUTPUT_RESOURCE:HAS[#ResourceName[Oxidizer]]]
	{
		@ConverterName = #LOC_CryoTanks_isru_LCH4_name
		@StartActionName = #LOC_CryoTanks_isru_LCH4_StartAction
		@StopActionName = #LOC_CryoTanks_isru_LCH4_StopAction
    	@ToggleActionName = #LOC_CryoTanks_isru_LCH4_ToggleAction
		Tag = CryoTanks_Methane

		@OUTPUT_RESOURCE:HAS[#ResourceName[LiquidFuel]]
		{
			@ResourceName = LqdMethane

			@Ratio *= 5 // legacy 23.48
		}
	}

	// patch LFOx to LCH4Ox
	+MODULE[ModuleResourceConverter]:HAS[@OUTPUT_RESOURCE:HAS[#ResourceName[LiquidFuel]],@OUTPUT_RESOURCE:HAS[#ResourceName[Oxidizer]]]
	{
    	@ConverterName = #LOC_CryoTanks_isru_LCH4Ox_name
		@StartActionName = #LOC_CryoTanks_isru_LCH4Ox_StartAction
		@StopActionName = #LOC_CryoTanks_isru_LCH4Ox_StopAction
    	@ToggleActionName = #LOC_CryoTanks_isru_LCH4Ox_ToggleAction
		Tag = CryoTanks_Methane

		@OUTPUT_RESOURCE:HAS[#ResourceName[LiquidFuel]]
		{
			@ResourceName = LqdMethane
			@Ratio /= 0.45
			@Ratio *= 1.875  // legacy 4.77
		}

		@OUTPUT_RESOURCE:HAS[#ResourceName[Oxidizer]]
		{
			@DumpExcess = true // false
			@Ratio /= 0.55
			@Ratio *= 0.625  // legacy 1.59
		}
	}

	//--------------------------

	@MODULE[ModuleResourceConverter]:HAS[#Tag[CryoTanks_Hydrogen]],*
	{
		@INPUT_RESOURCE:HAS[@ResourceName[ElectricCharge]]
		{
			@Ratio *= #$/CryoTanks_EC_Hydrogen$
		}
	}

	@MODULE[ModuleResourceConverter]:HAS[#Tag[CryoTanks_Methane]],*
	{
		@INPUT_RESOURCE:HAS[@ResourceName[ElectricCharge]]
		{
			@Ratio *= #$/CryoTanks_EC_Methane$
		}
	}

	-CryoTanks_Converter = none
	-CryoTanks_EC_Hydrogen = none
	-CryoTanks_EC_Methane = none

}


@PART:HAS[#CryoTanks_Power]:FOR[CryoTanks]
{
	@MODULE[ModuleResourceConverter]:HAS[#Tag[CryoTanks_*]],*
	{
		@INPUT_RESOURCE:HAS[~ResourceName[ElectricCharge]],*
		{
			@Ratio *= #$/CryoTanks_Power$
		}
		@OUTPUT_RESOURCE,*
		{
			@Ratio *= #$/CryoTanks_Power$
		}
	}
	-CryoTanks_Power = none
}